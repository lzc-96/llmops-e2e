    name: Docker CI/CD

    on:
      push:
        branches:
          - main # Trigger on pushes to the main branch
    
    jobs:
      build-and-push:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Log in to Docker Hub
            uses: docker/login-action@v3
            with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}

          - name: Build Docker image
            run: |
               # The image is built but not yet tagged with the final repo name
               docker build -t fastapi-app .

          - name: Test Docker image
            run: |
              # Run the container for testing (adjust the command for your app)
              docker run -d --name fastapi-test -p 8000:8000 fastapi-app
              
              # Wait for the container to start
              sleep 5

              # Simple health check (replace with real tests or curl endpoints)
              curl -f http://localhost:8000/docs || (echo "Container test failed" && exit 1)

              # Clean up
              docker stop fastapi-test
              docker rm fastapi-test

          - name: Tag Docker image
            run: |
              DOCKERHUB_USER=${{ secrets.DOCKERHUB_USERNAME }}
              REPO_NAME="fastapi-app"
              docker tag fastapi-app:build $DOCKERHUB_USER/$REPO_NAME:latest

          - name: Push Docker image
            run: |
              DOCKERHUB_USER=${{ secrets.DOCKERHUB_USERNAME }}
              REPO_NAME="fastapi-app"
              docker push $DOCKERHUB_USER/$REPO_NAME:latest

          
